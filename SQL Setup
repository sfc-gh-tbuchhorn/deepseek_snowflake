-- Step 1: Assign Account Admin Role and Grant Permissions
USE ROLE ACCOUNTADMIN;
CREATE ROLE IF NOT EXISTS deepseek_role;
GRANT BIND SERVICE ENDPOINT ON ACCOUNT TO ROLE DEEPSEEK_ROLE;
GRANT CREATE DATABASE ON ACCOUNT TO ROLE DEEPSEEK_ROLE;
GRANT CREATE COMPUTE POOL ON ACCOUNT TO ROLE DEEPSEEK_ROLE;
GRANT CREATE WAREHOUSE ON ACCOUNT TO ROLE DEEPSEEK_ROLE;

GRANT ROLE DEEPSEEK_ROLE TO USER <insert user>;

-- Step 2: Switch to DS_ROLE and Create Database
USE ROLE DEEPSEEK_ROLE;
CREATE DATABASE IF NOT EXISTS DEEPSEEK_DB;
USE DATABASE DEEPSEEK_DB;

-- Step 3: Create Compute Pool for GPU Resources and Warehouse for vector queries
CREATE COMPUTE POOL GPU_NV_M
  MIN_NODES = 1
  MAX_NODES = 4
  INSTANCE_FAMILY = GPU_NV_M;

CREATE WAREHOUSE IF NOT EXISTS DEEPSEEK_WH
    WITH WAREHOUSE_SIZE = XSMALL
    AUTO_SUSPEND = 300
    AUTO_RESUME = TRUE;

-- Step 4: Create Image Repository
CREATE OR REPLACE IMAGE REPOSITORY DEEPSEEK_REPO_IMAGE;

-- Step 5: Create Stage for LLM Models
CREATE OR REPLACE STAGE MODELS DIRECTORY = (ENABLE = TRUE) ENCRYPTION = (TYPE='SNOWFLAKE_SSE');

-- Step 6: Create Stage for YAML Service Definitions
CREATE OR REPLACE STAGE SPECS DIRECTORY = (ENABLE = TRUE) ENCRYPTION = (TYPE='SNOWFLAKE_SSE');

-- Step 7: Create Network Rule for External Access
CREATE OR REPLACE NETWORK RULE HUGGING_FACE_NETWORK MODE = EGRESS TYPE = HOST_PORT VALUE_LIST = ('0.0.0.0');

-- Step 8: Switch Back to Account Admin Role and Create External Access Integration
CREATE OR REPLACE EXTERNAL ACCESS INTEGRATION HUGGING_FACE_INTEGRATION ALLOWED_NETWORK_RULES = (HUGGING_FACE_NETWORK) ENABLED = TRUE;

-- Step 9: Grant Integration Usage to DEEPSEEK_ROLE
GRANT USAGE ON INTEGRATION HUGGING_FACE_INTEGRATION TO ROLE DEEPSEEK_ROLE;

-- Step 10: Switch Back to DEEPSEEK_ROLE and Verify Image Repositories
USE ROLE DEEPSEEK_ROLE;
SHOW IMAGE REPOSITORIES;

-- Step 11: Create Service Using Specifications
CREATE SERVICE DEEPSEEK
  IN COMPUTE POOL GPU_NV_M
  FROM @SPECS SPEC='spec.yml'
  EXTERNAL_ACCESS_INTEGRATIONS = (HUGGING_FACE_INTEGRATION);

-- Step 12: Verify Service Creation and Status
SHOW SERVICES;
CALL SYSTEM$GET_SERVICE_STATUS('DEEPSEEK');
CALL SYSTEM$GET_SERVICE_LOGS('DEEPSEEK', '0', 'ui', '1000');
CALL SYSTEM$GET_SERVICE_LOGS('DEEPSEEK', '0', 'deepseek', '1000');
CALL SYSTEM$GET_SERVICE_LOGS('DEEPSEEK', '0', 'relay', '1000');

-- Step 13: Display Service Endpoints and Containers. Take the endpoint and log in. You should see Streamlit UI to DeepSeek
SHOW ENDPOINTS IN SERVICE DEEPSEEK;
SHOW SERVICE CONTAINERS IN SERVICE DEEPSEEK;

-- Step 14: Create Service function
CREATE OR REPLACE FUNCTION deepseek_chat_udf(text varchar)
   RETURNS varchar
   SERVICE=deepseek
   ENDPOINT=relay
   AS '/relay';

SELECT deepseek_chat_udf('What is the capital of the moon');

-- Step 15: Create a new Role to demonstrate RLS
USE ROLE ACCOUNTADMIN;
CREATE ROLE IF NOT EXISTS BICYCLES;
GRANT USAGE ON DATABASE DEEPSEEK_DB TO ROLE BICYCLES;
GRANT USAGE ON SCHEMA DEEPSEEK_DB.RAGTOAI TO ROLE BICYCLES;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA DEEPSEEK_DB.RAGTOAI TO ROLE BICYCLES;
GRANT USAGE ON WAREHOUSE DEEPSEEK_WH TO ROLE BICYCLES;

-- Create another User
CREATE OR REPLACE USER bicycle_user
  PASSWORD = 'AStrongPassword123'
  DEFAULT_ROLE = BICYCLES
  MUST_CHANGE_PASSWORD = TRUE
  COMMENT = 'User for testing RLS on unstructured data.';

GRANT ROLE BICYCLES TO USER bicycle_user;
ALTER USER bicycle_user SET DEFAULT_ROLE = BICYCLES;

-- Create Row Access Policy
create or replace row access policy DEEPSEEK_REGION_RLS as (DEPARTMENT VARCHAR) 
returns BOOLEAN ->
CURRENT_ROLE() = 'DEEPSEEK_ROLE' OR department = CURRENT_ROLE()
;

create or replace TABLE DEEPSEEK_DB.RAGTOAI.RAG_CHUNKED_EMBEDDED_TABLE_RLS (
	RELATIVE_PATH VARCHAR(16777216),
	SIZE NUMBER(38,0),
	FILE_URL VARCHAR(16777216),
	SCOPED_FILE_URL VARCHAR(16777216),
	CHUNK VARCHAR(16777216),
	CONTEXT VARCHAR(16777216),
	CHUNK_VEC VECTOR(FLOAT, 384),
	DEPARTMENT VARCHAR(8)
) WITH ROW ACCESS POLICY DEEPSEEK_DB.RAGTOAI.DEEPSEEK_REGION_RLS ON (DEPARTMENT)
;

ALTER TABLE DEEPSEEK_DB.RAGTOAI.RAG_CHUNKED_EMBEDDED_TABLE_RLS
ADD ROW ACCESS POLICY DEEPSEEK_DB.RAGTOAI.DEEPSEEK_REGION_RLS ON (DEPARTMENT);

-- Test the policies
USE ROLE BICYCLES;
SELECT * FROM DEEPSEEK_DB.RAGTOAI.RAG_CHUNKED_EMBEDDED_TABLE_RLS;
USE ROLE DEEPSEEK_ROLE;
SELECT * FROM DEEPSEEK_DB.RAGTOAI.RAG_CHUNKED_EMBEDDED_TABLE_RLS;


-- Step 16: Grant Caller Rights
USE ROLE ACCOUNTADMIN;
GRANT ALL CALLER PRIVILEGES ON DATABASE DEEPSEEK_DB TO ROLE DEEPSEEK_ROLE;
GRANT ALL INHERITED CALLER PRIVILEGES ON ALL SCHEMAS IN DATABASE DEEPSEEK_DB TO ROLE DEEPSEEK_ROLE;
GRANT INHERITED CALLER SELECT, INSERT ON ALL TABLES IN SCHEMA DEEPSEEK_DB.RAGTOAI TO ROLE DEEPSEEK_ROLE;
GRANT CALLER USAGE ON WAREHOUSE DEEPSEEK_WH TO ROLE DEEPSEEK_ROLE;

ALTER SERVICE DEEPSEEK SUSPEND;
