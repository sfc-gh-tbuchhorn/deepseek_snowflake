-- Step 1: Assign Account Admin Role and Grant Permissions
USE ROLE ACCOUNTADMIN;
CREATE ROLE IF NOT EXISTS deepseek_role;
GRANT BIND SERVICE ENDPOINT ON ACCOUNT TO ROLE DEEPSEEK_ROLE;
GRANT CREATE DATABASE ON ACCOUNT TO ROLE DEEPSEEK_ROLE;
GRANT CREATE COMPUTE POOL ON ACCOUNT TO ROLE DEEPSEEK_ROLE;

GRANT ROLE DEEPSEEK_ROLE TO USER <insert user>;

-- Step 2: Switch to DS_ROLE and Create Database
USE ROLE DEEPSEEK_ROLE;
CREATE DATABASE IF NOT EXISTS DEEPSEEK_DB;
USE DATABASE DEEPSEEK_DB;

-- Step 3: Create Compute Pool for GPU Resources
CREATE COMPUTE POOL GPU_NV_M
  MIN_NODES = 1
  MAX_NODES = 4
  INSTANCE_FAMILY = GPU_NV_M;

-- Step 4: Create Image Repository
CREATE OR REPLACE IMAGE REPOSITORY DEEPSEEK_REPO_IMAGE;

-- Step 5: Create Stage for LLM Models
CREATE OR REPLACE STAGE MODELS DIRECTORY = (ENABLE = TRUE) ENCRYPTION = (TYPE='SNOWFLAKE_SSE');

-- Step 6: Create Stage for YAML Service Definitions
CREATE OR REPLACE STAGE SPECS DIRECTORY = (ENABLE = TRUE) ENCRYPTION = (TYPE='SNOWFLAKE_SSE');

-- Step 7: Create Network Rule for External Access
CREATE OR REPLACE NETWORK RULE HUGGING_FACE_NETWORK MODE = EGRESS TYPE = HOST_PORT VALUE_LIST = ('0.0.0.0');

-- Step 8: Switch Back to Account Admin Role and Create External Access Integration
CREATE OR REPLACE EXTERNAL ACCESS INTEGRATION HUGGING_FACE_INTEGRATION ALLOWED_NETWORK_RULES = (HUGGING_FACE_NETWORK) ENABLED = TRUE;

-- Step 9: Grant Integration Usage to DEEPSEEK_ROLE
GRANT USAGE ON INTEGRATION HUGGING_FACE_INTEGRATION TO ROLE DEEPSEEK_ROLE;

-- Step 10: Switch Back to DEEPSEEK_ROLE and Verify Image Repositories
USE ROLE DEEPSEEK_ROLE;
SHOW IMAGE REPOSITORIES;

-- Step 11: Create Service Using Specifications
CREATE SERVICE DEEPSEEK
  IN COMPUTE POOL GPU_NV_M
  FROM @SPECS SPEC='spec.yml'
  EXTERNAL_ACCESS_INTEGRATIONS = (HUGGING_FACE_INTEGRATION);

-- Step 12: Verify Service Creation and Status
SHOW SERVICES;
CALL SYSTEM$GET_SERVICE_STATUS('DEEPSEEK');
CALL SYSTEM$GET_SERVICE_LOGS('DEEPSEEK', '0', 'ui', '1000');
CALL SYSTEM$GET_SERVICE_LOGS('DEEPSEEK', '0', 'deepseek', '1000');
CALL SYSTEM$GET_SERVICE_LOGS('DEEPSEEK', '0', 'relay', '1000');

-- Step 13: Display Service Endpoints and Containers. Take the endpoint and log in. You should see Streamlit UI to DeepSeek
SHOW ENDPOINTS IN SERVICE DEEPSEEK;
SHOW SERVICE CONTAINERS IN SERVICE DEEPSEEK;

-- Step 14: Create Service function
CREATE OR REPLACE FUNCTION deepseek_chat_udf(text varchar)
   RETURNS varchar
   SERVICE=deepseek
   ENDPOINT=relay
   AS '/relay';

SELECT deepseek_chat_udf('What is the capital of the moon');

ALTER SERVICE DEEPSEEK SUSPEND;
